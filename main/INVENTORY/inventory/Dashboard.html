<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }
      body {
        background-color: #D4A6A6;
        margin: 0;
        padding: 40px;
        display: flex;
        gap: 0;
      }
      .sidebar {
        background-color: #2D2D2D;
        width: 200px;
        min-height: calc(100vh - 80px);
        border-radius: 8px 0 0 8px;
        padding: 20px;
        color: white;
        display: flex;
        flex-direction: column;
      }
      .logo img {
        height: 160px;
        width: auto;  
        display: block;
        margin: 0 auto;
      }
      .menu-item {
        padding: 12px 16px;
        margin: 4px 0;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
      }
      .menu-item.active {
        background-color: #FFA500;
        color: #2D2D2D;
      }
      .menu-item:not(.active):hover {
        background-color: #404040;
      }
      .dashboard-container {
        background-color: white;
        flex: 1;
        border-radius: 0 8px 8px 0;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: calc(100vh - 80px);
        position: relative;
      }
      .dashboard-main-container {
        width: 100%;
        min-height: calc(100vh - 80px);
        position: relative;
        background: #F8ECEC;
        overflow: hidden;
      }
      .logout-btn {
        position: absolute;
        bottom: 40px;
        left: 20px;
        width: 160px;
        background: none;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-align: left;
        transition: background 0.2s, color 0.2s;
      }
      .logout-btn:hover {
        background-color: #FF6060;
        color: white;
      }
    </style>
</head>
<body>
  <div class="sidebar" style="position: relative;">
    <div class="logo">
      <img src="/main/images/logo.png" alt="Buffalo's Logo" >
    </div>
    <div class="menu-item active">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
      </svg>
      DASHBOARD
    </div>
    <a href="/main/INVENTORY/inventory/index.html" style="text-decoration: none; color: inherit;">
      <div class="menu-item">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <path d="M7 4V2C7 1.45 7.45 1 8 1h8c.55 0 1 .45 1 1v2h5v2h-2v13c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V6H2V4h5zM9 3v1h6V3H9zm-1 5v10h8V8H8z"/>
        </svg>
        INVENTORY
      </div>
    </a>
    <!-- Logout Button -->
    <div class="menu-item logout-btn" onclick="window.location.href='../login/login.html'">Logout</div>
  </div>
  <div class="dashboard-container">
    <div class="dashboard-main-container">
        <!-- table -->
        <div style="width: 772px; height: 1000px; left: 10px; position: absolute; background: rgb(255, 255, 255)"></div>
        <div style="width: 772px; height: 0px; left: 10px; top: 178px; position: absolute; outline: 3px #F9EDED solid; outline-offset: -1.50px"></div>
      
        <div style="width: 835px; height: 500px; left: 800px; top: 0px; position: absolute; background: white"></div>
        <div style="width: 800px; height: 480px; left: 820px; top: 10px; position: absolute; background: #FFF6F6"></div>

        <!-- out of stock or low quantity -->
        <div style="width: 835px; height: 407px; left: 800px; top: 520px; position: absolute; background: white"></div>
        <!-- Search Bar-->
        <div style="position: absolute; left: 110px; top: 60px; width: 540px; height: 40px; background: #F4DEDE; border-radius: 30px; display: flex; align-items: center; padding: 0 18px; z-index: 2;">
          <input id="dashboard-search" type="text" placeholder="Search..." style="width: 100%; border: none; background: transparent; outline: none; font-size: 16px; color: #333;" />
        </div>
        
        <div style="left: 90px; top: 142px; position: absolute; color: #B5B9BF; font-size: 16px; font-family: Roboto; font-weight: 500; word-wrap: break-word">NAME</div>
        <div style="left: 320px; top: 142px; position: absolute; color: #B5B9BF; font-size: 16px; font-family: Roboto; font-weight: 500; word-wrap: break-word">QUANTITY</div>
        <div style="left: 600px; top: 144px; position: absolute; color: #B5B9BF; font-size: 16px; font-family: Roboto; font-weight: 500; word-wrap: break-word">PRICE</div>
        
        <!-- bar chart of the total items by date and total items by category. The user can toggle between the two charts. -->
        <div style="width: 400px; height: 51px; left: 1100px; top: 20px; position: absolute; color: black; font-size: 22px; font-family: Roboto; font-weight: 600; word-wrap: break-word">BAR CHART OF THE ITEMS</div>
        <div id="chart-toggle-container" style="position: absolute; left: 840px; top: 70px; width: 400px; display: flex; gap: 10px;">
          <button id="toggle-date" style="flex:1; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-weight: 600;">By Date</button>
          <button id="toggle-category" style="flex:1; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-weight: 600;">By Category</button>
        </div>
        <div style="position: absolute; left: 840px; top: 110px; width: 800px; height: 350px; background: #FFF6F6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
          <canvas id="inventory-bar-chart" style="width:100%;height:100%;"></canvas>
        </div>
        <!-- out of stock or low quantity -->
        <div style="width: 405px; height: 51px; left: 1150px; top: 550px; position: absolute; color: black; font-size: 20px; font-family: Roboto; font-weight: 600; word-wrap: break-word; z-index: 2;">Running Low</div>
        <div style="width: 800px; height: 340px; left: 820px; top: 530px; position: absolute; background: #FFF6F6; z-index: 1;"></div>
        <!-- Running Low Table -->
        <div id="low-inventory-table-container" style="position: absolute; left: 850px; top: 600px; width: 700px; height: 250px; overflow-y: auto; z-index: 3; padding-right: 24px;">
          <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; margin: 0 auto;">
            <thead>
              <tr>
                <th style='text-align:left; padding-left:32px; color:#B5B9BF; font-size:16px; font-family:Roboto; font-weight:500;'>NAME</th>
                <th style='text-align:center; color:#B5B9BF; font-size:16px; font-family:Roboto; font-weight:500;'>QUANTITY</th>
                <th style='text-align:right; color:#B5B9BF; font-size:16px; font-family:Roboto; font-weight:500;'>PRICE</th>
              </tr>
            </thead>
            <tbody id="low-inventory-body">
              <!-- Low items will be inserted here -->
            </tbody>
          </table>
        </div>
        <!-- Inventory Table --> 
        <div id="inventory-table-container" style="position: absolute; left: 60px; top: 180px; width: 650px; bottom: 40px; overflow-y: auto; padding-right: 16px;">
          <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; margin: 0 auto;">
            <tbody id="dashboard-inventory-body">
              <!-- Items will be inserted here -->
            </tbody>
          </table>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        let dashboardItems = [];
        let chartInstance = null;
        let currentChartType = 'date';
        async function loadDashboardInventory() {
          try {
            const response = await fetch('http://localhost:3000/api/inventory');
            if (!response.ok) throw new Error('Failed to fetch inventory');
            dashboardItems = await response.json();
            renderDashboardInventory(dashboardItems);
            renderLowInventory(dashboardItems);
            renderBarChart('date');
          } catch (err) {
            console.error('Error loading dashboard inventory:', err);
          }
        }
        function renderDashboardInventory(items) {
          const tbody = document.getElementById('dashboard-inventory-body');
          tbody.innerHTML = '';
          // Sort items alphabetically by name
          const sorted = [...items].sort((a, b) => a.name.localeCompare(b.name));
          sorted.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style=\"padding: 8px 0 8px 32px; font-size: 16px; width: 20%; text-align: left;\">${item.name}</td>
              <td style=\"padding: 8px 0; font-size: 16px; width: 20%; text-align: center;\">${item.quantity}</td>
              <td style=\"padding: 8px 0 8px 0; font-size: 16px; width: 20%; text-align: right;\">${item.price}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        function renderLowInventory(items) {
          const tbody = document.getElementById('low-inventory-body');
          tbody.innerHTML = '';
          // Filter and sort items with quantity < 20
          const lowItems = items.filter(item => item.quantity <= 20).sort((a, b) => a.name.localeCompare(b.name));
          lowItems.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style=\"padding: 8px 0 8px 32px; font-size: 16px; width: 20%; text-align: left;\">${item.name}</td>
              <td style=\"padding: 8px 0; font-size: 16px; width: 20%; text-align: center; font-weight: bold;\">${item.quantity}</td>
              <td style=\"padding: 8px 0 8px 0; font-size: 16px; width: 20%; text-align: right;\">${item.price}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        function renderBarChart(type) {
          const ctx = document.getElementById('inventory-bar-chart').getContext('2d');
          let labels = [];
          let data = [];
          if (type === 'date') {
            // Group by date_added
            const dateMap = {};
            dashboardItems.forEach(item => {
              const date = new Date(item.date_added).toLocaleDateString();
              dateMap[date] = (dateMap[date] || 0) + 1;
            });
            labels = Object.keys(dateMap);
            data = Object.values(dateMap);
          } else if (type === 'category') {
            // Group by category
            const catMap = {};
            dashboardItems.forEach(item => {
              const cat = item.category || 'Uncategorized';
              catMap[cat] = (catMap[cat] || 0) + 1;
            });
            labels = Object.keys(catMap);
            data = Object.values(catMap);
          }
          if (chartInstance) chartInstance.destroy();
          chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: type === 'date' ? 'Total Items by Date' : 'Total Items by Category',
                data: data,
                backgroundColor: '#FFA500',
                borderRadius: 6,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: false }
              },
              scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, grid: { color: '#eee' } }
              }
            }
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          const searchInput = document.getElementById('dashboard-search');
          searchInput.addEventListener('input', function() {
            const term = searchInput.value.toLowerCase();
            const filtered = dashboardItems.filter(item =>
              item.name.toLowerCase().includes(term) ||
              String(item.quantity).toLowerCase().includes(term) ||
              String(item.price).toLowerCase().includes(term)
            );
            renderDashboardInventory(filtered);
            renderLowInventory(filtered);
          });
          document.getElementById('toggle-date').addEventListener('click', function() {
            currentChartType = 'date';
            renderBarChart('date');
          });
          document.getElementById('toggle-category').addEventListener('click', function() {
            currentChartType = 'category';
            renderBarChart('category');
          });
        });
        loadDashboardInventory();
        </script>
    </div>
  </div>
</body>
</html>
